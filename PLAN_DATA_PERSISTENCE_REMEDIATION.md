# План исправления сохранения данных (Data Persistence Remediation Plan)

**Цель:** Устранить "Hybrid State Schizophrenia" (двойственность состояния) путем переноса критически важных данных (история чата, прогресс, настройки) из `localStorage` в базу данных PostgreSQL.

**Основание:** [AUDIT_DATA_PERSISTENCE_2026_01_10.md](./AUDIT_DATA_PERSISTENCE_2026_01_10.md)

## Этап 1: Подготовка Базы Данных

### 1.1. Миграция схемы
- [ ] Создать файл миграции `database/migrations/002_add_user_preferences.sql`.
- [ ] Добавить колонку `preferences` (JSONB) в таблицу `users` для хранения настроек (звук, тема и т.д.).
- [ ] Применить миграцию.

## Этап 2: Backend (API)

### 2.1. Чат (API /api/chat)
- [ ] **История чата (GET):** Реализовать обработку `GET /api/chat` (или `/api/chat/history`) для получения последних 50 сообщений пользователя из таблицы `chat_messages`.
- [ ] **Сохранение сообщений (POST):** В `POST /api/chat`:
    - [ ] Сохранять сообщение пользователя в `chat_messages` *перед* отправкой запроса к AI.
    - [ ] Сохранять ответ AI в `chat_messages` *после* завершения стриминга (или по частям, но проще целиком в конце).
    - [ ] *Важно:* Учесть обработку ошибок OpenRouter, чтобы не терять сообщения пользователя.

### 2.2. Прогресс (API /api/progress)
- [ ] Проверить текущий эндпоинт `GET /api/progress`. Убедиться, что он возвращает корректный формат для фронтенда (`{ roadmapId: [stepId, ...] }`).
- [ ] *Опционально:* Оптимизировать `POST` для массового обновления (если потребуется миграция старых данных).

### 2.3. Настройки пользователя (API /api/users/preferences)
- [ ] Создать эндпоинт `PATCH /api/users/preferences` (или расширить `/api/auth/me`) для обновления JSONB поля `preferences`.

## Этап 3: Frontend (Клиент)

### 3.1. Ассистент (Assistant.tsx)
- [ ] **Загрузка:** При монтировании компонента загружать историю через `GET /api/chat`.
- [ ] **Отправка:** Убрать сохранение в `localStorage`. Полагаться на то, что бэкенд сохраняет историю.
- [ ] **Очистка:** При нажатии "Очистить историю" отправлять `DELETE /api/chat` (нужно реализовать и на бэке) или просто очищать стейт и делать пометку в БД (soft delete).

### 3.2. Дорожные карты (Roadmaps.tsx)
- [ ] **Чтение:** Убрать чтение из `localStorage` при инициализации. Использовать только данные из `GET /api/progress`.
- [ ] **Миграция (One-time):** Оставить (или улучшить) логику "если на сервере пусто, а локально есть — отправить на сервер". После успешной отправки — очищать `localStorage`.

### 3.3. Приложение (App.tsx / Onboarding)
- [ ] **Онбординг:** Убрать проверку `vibes_onboarded_{id}` из `localStorage`. Полностью полагаться на поле `user.onboardingCompleted` из `/api/auth/me`.
- [ ] **Тема и Звук:**
    - [ ] При загрузке приложения (`App.tsx`) брать настройки из профиля пользователя (если он залогинен).
    - [ ] При изменении темы/звука отправлять запрос на бэкенд (debounced).

## Этап 4: Тестирование и Зачистка

- [ ] Проверить сценарий: Новый вход с чистого браузера -> История чата подгрузилась.
- [ ] Проверить сценарий: Прохождение шага Roadmap на телефоне -> Отображение прогресса на десктопе.
- [ ] Удалить неиспользуемый код, связанный с `localStorage` (ключи `vibes_chat_history`, `vibes_roadmap_progress` и т.д.).

---
**Порядок выполнения:** 1 -> 2 -> 3 -> 4.
