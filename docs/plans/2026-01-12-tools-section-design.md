# Дизайн раздела "Инструменты"

**Дата:** 2026-01-12
**Статус:** Утверждён

## Обзор

Раздел "Ассистент" переименовывается в "Инструменты" — витрина с тремя AI-инструментами для учеников.

## Инструменты

| Инструмент | Описание | Модель |
|------------|----------|--------|
| Ассистент | Универсальный помощник по вайб-кодингу (текущий) | `google/gemini-2.5-flash-lite` |
| Помощник по ТЗ | Создание технического задания для проекта | `z-ai/glm-4.7` |
| Идеи для проектов | Генерация персонализированных идей | `xiaomi/mimo-v2-flash:free` |

## Навигация

### Главный экран раздела
Витрина из трёх карточек с иконками и описаниями. Клик на карточку → открывается инструмент.

### Внутри инструмента
- Кнопка "←" в шапке для возврата к списку карточек
- Чат-интерфейс (как текущий ассистент)
- История сохраняется между сессиями

### Переход между инструментами
Из "Идеи для проектов" можно перейти в "Помощник по ТЗ" с выбранной идеей — кнопка "Создать ТЗ для этой идеи →".

## UI компоненты

### Специфичные элементы

**Помощник по ТЗ:**
- Готовое ТЗ выделяется особым оформлением (рамка/фон)
- Кнопка "Скопировать ТЗ" под сообщением
- Маркер в тексте: `[ТЗ_START]...[ТЗ_END]`

**Идеи для проектов:**
- Кнопка "Создать ТЗ для этой идеи →" под выбранной идеей
- Маркер в тексте: `[IDEA_START]...[IDEA_END]`

### Новые компоненты

| Компонент | Описание |
|-----------|----------|
| `ToolsView.tsx` | Главный экран с карточками |
| `ToolCard.tsx` | Карточка инструмента |
| `ToolChat.tsx` | Универсальный чат для всех инструментов |
| `CopyableMessage.tsx` | Сообщение с кнопкой копирования |
| `IdeaMessage.tsx` | Сообщение с кнопкой перехода в ТЗ |
| `AdminToolSettings.tsx` | Админка: настройки инструментов |

## База данных

### Новая таблица `tool_chats`

```sql
CREATE TABLE tool_chats (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    tool_type VARCHAR(20) NOT NULL CHECK (tool_type IN ('assistant', 'tz_helper', 'ideas')),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, tool_type)
);
```

### Новая таблица `tool_messages`

```sql
CREATE TABLE tool_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    chat_id UUID NOT NULL REFERENCES tool_chats(id) ON DELETE CASCADE,
    role VARCHAR(10) NOT NULL CHECK (role IN ('user', 'assistant')),
    content TEXT NOT NULL,
    has_copyable_content BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_tool_messages_chat_id ON tool_messages(chat_id);
CREATE INDEX idx_tool_messages_created_at ON tool_messages(created_at);
```

### Изменения в `ai_system_instructions`

```sql
ALTER TABLE ai_system_instructions
ADD COLUMN tool_type VARCHAR(20) CHECK (tool_type IN ('assistant', 'tz_helper', 'ideas')),
ADD COLUMN model_id VARCHAR(100);
```

### Миграция данных

```sql
-- Создать чаты для существующих пользователей
INSERT INTO tool_chats (user_id, tool_type)
SELECT DISTINCT user_id, 'assistant' FROM chat_messages;

-- Перенести сообщения
INSERT INTO tool_messages (chat_id, role, content, created_at)
SELECT tc.id, cm.role, cm.content, cm.created_at
FROM chat_messages cm
JOIN tool_chats tc ON tc.user_id = cm.user_id AND tc.tool_type = 'assistant';
```

## API эндпоинты

### Новый файл `/api/tools.ts`

| Эндпоинт | Метод | Описание |
|----------|-------|----------|
| `/api/tools/chats` | GET | Получить чат пользователя по tool_type |
| `/api/tools/chats` | POST | Создать новый чат |
| `/api/tools/messages` | GET | История сообщений чата |
| `/api/tools/messages` | POST | Отправить сообщение + получить ответ ИИ |
| `/api/tools/prompts` | GET | Получить системный промпт |
| `/api/tools/transfer` | POST | Перенести идею в другой инструмент |

### Обратная совместимость

Старый `/api/chat` продолжает работать, внутри перенаправляет на `/api/tools` с `tool_type = 'assistant'`.

## Админ-панель

Раздел "Ассистент" в админке переименовывается в "Инструменты".

### Интерфейс настройки

Три карточки — по одной на каждый инструмент:
- Выпадающий список для выбора модели (или ручной ввод)
- Большое текстовое поле для системного промпта
- Кнопка "Сохранить"

## Системные промпты

### Ассистент
Существующий промпт, без изменений.

### Помощник по ТЗ
Готовый промпт от заказчика. Выдаёт структурированное ТЗ с разделами:
- Цель проекта
- Функционал
- Дизайн
- Технологии
- Этапы

Готовое ТЗ оборачивается в `[ТЗ_START]...[ТЗ_END]`.

### Идеи для проектов

**Поток диалога:**
1. Приветствие + вопрос про нишу/профессию
2. Вопрос про уровень опыта в вайб-кодинге
3. Вопрос про цель проекта (портфолио / для себя / на продажу / автоматизация)
4. Вопрос про желаемую сложность
5. Предложить 3-4 персонализированные категории на основе ответов
6. После выбора категории — 5 идей списком
7. Ученик выбирает — краткое описание (2-3 предложения)
8. Если не нравится — можно попросить ещё 5 или объяснить что хочется другого

Выбранная идея оборачивается в `[IDEA_START]...[IDEA_END]` для показа кнопки перехода.

## Роутинг

| URL | Компонент | Описание |
|-----|-----------|----------|
| `/tools` | `ToolsView` | Главный экран с карточками |
| `/tools/assistant` | `ToolChat` | Ассистент |
| `/tools/tz` | `ToolChat` | Помощник по ТЗ |
| `/tools/ideas` | `ToolChat` | Идеи для проектов |

TabId: `assistant` → `tools`

## План реализации

1. **База данных**
   - Создать таблицы `tool_chats`, `tool_messages`
   - Добавить поля в `ai_system_instructions`
   - Мигрировать данные из `chat_messages`

2. **API**
   - Создать `/api/tools.ts` с эндпоинтами
   - Обновить `/api/chat.ts` для обратной совместимости

3. **Фронтенд — пользовательская часть**
   - Создать `ToolsView.tsx` с карточками
   - Создать `ToolChat.tsx` с поддержкой маркеров
   - Обновить навигацию (TabId)

4. **Фронтенд — админка**
   - Обновить раздел "Ассистент" → "Инструменты"
   - Добавить настройки для каждого инструмента

5. **Системные промпты**
   - Добавить промпт для "Помощник по ТЗ"
   - Создать промпт для "Идеи для проектов"

6. **Тестирование**
   - Проверить миграцию существующих чатов
   - Протестировать все три инструмента
   - Проверить переход из "Идей" в "ТЗ"

## Верификация

- [ ] История существующего ассистента сохранилась после миграции
- [ ] Все три инструмента открываются и работают
- [ ] Кнопка "Скопировать ТЗ" копирует текст в буфер
- [ ] Кнопка "Создать ТЗ для этой идеи" переносит идею в помощник по ТЗ
- [ ] Админ может изменить модель и промпт для каждого инструмента
- [ ] Навигация "назад" возвращает к списку карточек
